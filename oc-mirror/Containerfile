# Containerfile for oc-mirror with AutoShift integration
FROM registry.access.redhat.com/ubi9/ubi-minimal:latest

# Install runtime dependencies
RUN microdnf update -y && \
    microdnf install -y ca-certificates wget tar gzip bash jq findutils && \
    microdnf clean all

# We'll download oc-mirror after copying values file to get the version dynamically

# Create non-root user
RUN useradd -r -u 1001 -g root oc-mirror-user

# Create working directory and AutoShift structure
WORKDIR /workspace
RUN mkdir -p /workspace/autoshift /workspace/scripts /workspace/cache && \
    chown -R 1001:0 /workspace && chmod -R g+rwX /workspace

# Set environment variables for oc-mirror v2
ENV HOME=/workspace
ENV XDG_CACHE_HOME=/workspace/cache
ENV XDG_RUNTIME_DIR=/workspace

# Copy AutoShift values files
COPY autoshift/values.hub.yaml /workspace/autoshift/

# Download and install oc and oc-mirror binaries
# Extract all openshift-version values from labels sections, use highest version
RUN OCP_VERSIONS=$(grep -A 200 "labels:" /workspace/autoshift/values.hub.yaml | grep "openshift-version:" | sed 's/.*openshift-version:[[:space:]]*//' | tr -d "'" | tr -d '"' | sort -V) && \
    OCP_VERSION=$(echo "$OCP_VERSIONS" | tail -1) && \
    OCP_VERSION=${OCP_VERSION:-"4.18.22"} && \
    VERSION_COUNT=$(echo "$OCP_VERSIONS" | grep -c .) && \
    if [ "$VERSION_COUNT" -gt 1 ]; then \
        echo "⚠️ Multiple OpenShift versions detected in labels: $(echo $OCP_VERSIONS | tr '\n' ' ')"; \
        echo "⚠️ Using highest version for binary downloads: $OCP_VERSION"; \
    fi && \
    if [[ "$OCP_VERSION" =~ ^([0-9]+\.[0-9]+) ]]; then \
        OCP_MAJOR_MINOR="${BASH_REMATCH[1]}"; \
    else \
        OCP_MAJOR_MINOR="4.18"; \
    fi && \
    echo "Detected OpenShift version: $OCP_VERSION (using latest stable oc-mirror, versioned oc client)" && \
    ARCH=$(uname -m) && \
    cd /tmp && \
    if [ "$ARCH" = "aarch64" ]; then \
        # Download latest stable oc-mirror (recommended for compatibility) \
        wget -q https://mirror.openshift.com/pub/openshift-v4/arm64/clients/ocp/stable/oc-mirror.tar.gz && \
        # Download oc client matching OpenShift version \
        wget -q https://mirror.openshift.com/pub/openshift-v4/arm64/clients/ocp/stable-${OCP_MAJOR_MINOR}/openshift-client-linux.tar.gz; \
    else \
        # Download latest stable oc-mirror (recommended for compatibility) \
        wget -q https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable/oc-mirror.tar.gz && \
        # Download oc client matching OpenShift version \
        wget -q https://mirror.openshift.com/pub/openshift-v4/x86_64/clients/ocp/stable-${OCP_MAJOR_MINOR}/openshift-client-linux.tar.gz; \
    fi && \
    # Install oc-mirror \
    tar -xzf oc-mirror.tar.gz && \
    mv oc-mirror /usr/local/bin/ && \
    chmod +x /usr/local/bin/oc-mirror && \
    # Install oc client \
    tar -xzf openshift-client-linux.tar.gz && \
    mv oc /usr/local/bin/ && \
    mv kubectl /usr/local/bin/ && \
    chmod +x /usr/local/bin/oc /usr/local/bin/kubectl && \
    # Cleanup \
    rm -f oc-mirror.tar.gz openshift-client-linux.tar.gz README.md

# Pull secret will be mounted at runtime from either:
# - Kubernetes secret (pipeline deployment)
# - Host file mount (podman/docker run)
# The entrypoint script will detect the source and set up accordingly

# Copy oc-mirror workflow scripts and configurations
COPY oc-mirror/entrypoint.sh /workspace/autoshift-entrypoint.sh
COPY oc-mirror/generate-imageset-config.sh /workspace/
COPY oc-mirror/mirror-to-disk.sh /workspace/
COPY oc-mirror/disk-to-mirror.sh /workspace/
COPY oc-mirror/mirror-to-mirror.sh /workspace/
COPY oc-mirror/delete-generate.sh /workspace/
COPY oc-mirror/delete-execute.sh /workspace/

# Set executable permissions for all scripts and fix ownership
RUN chmod +x /workspace/autoshift-entrypoint.sh \
             /workspace/generate-imageset-config.sh \
             /workspace/mirror-to-disk.sh \
             /workspace/disk-to-mirror.sh \
             /workspace/mirror-to-mirror.sh \
             /workspace/delete-generate.sh \
             /workspace/delete-execute.sh && \
    chown -R 1001:0 /workspace

# Switch to non-root user
USER 1001

# Set entrypoint to our custom script
ENTRYPOINT ["/workspace/autoshift-entrypoint.sh"]

# Default command runs bash for interactive use
CMD ["/bin/bash"]

# Labels for metadata
LABEL name="oc-mirror-autoshift" \
      description="OpenShift oc-mirror tool with comprehensive workflow support for disconnected installations" \
      version="${OCP_MAJOR_MINOR}-stable" \
      maintainer="AutoShift Team" \
      io.openshift.tags="openshift,mirror,disconnected,autoshift,workflows,lifecycle" \
      io.k8s.description="Complete oc-mirror solution with AutoShift integration, workflow orchestration, and image lifecycle management" \
      io.k8s.display-name="oc-mirror AutoShift Enhanced" \
      workflows.autoshift.io/mirror-to-disk="true" \
      workflows.autoshift.io/disk-to-mirror="true" \
      workflows.autoshift.io/mirror-to-mirror="true" \
      workflows.autoshift.io/delete-management="true" \
      workflows.autoshift.io/imageset-generation="true"