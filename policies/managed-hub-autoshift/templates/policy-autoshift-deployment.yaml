{{- $policyName := "policy-managed-hub-autoshift" }}
{{- $policyNamespace := $.Values.policy_namespace }}
{{- $placementName := printf "%s-%s" "placement" $policyName }}
---
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: {{ $policyName }}
  namespace: {{ $policyNamespace }}
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/standards: NIST SP 800-53
spec: 
  dependencies:
    - apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: Policy
      name: policy-gitops-systems-argocd
      namespace: {{  $policyNamespace }}
    - apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: Policy
      name: policy-acm-mch-install
      namespace: {{  $policyNamespace }}
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: autoshift-deploy
        spec:
          remediationAction: enforce
          severity: high
          object-templates-raw: |
            {{ "{{" }} $appName := "{{ "{{hub" }} .ManagedClusterName {{ "hub}}" }}" {{ "}}" }}
            {{ "{{hub" }} $repoUrlConfigMap := (lookup "v1" "ConfigMap" "{{ $policyNamespace }}" "autoshift-repo-urls" | default (dict)) {{ "hub}}" }}
            {{ "{{hub" }} if not (empty $repoUrlConfigMap) {{ "hub}}" }}
            {{ "{{" }} $repoUrl := "{{ "{{hub" }} (index $repoUrlConfigMap "data" (index .ManagedClusterLabels "cluster.open-cluster-management.io/clusterset" | default "") | default "") {{ "hub}}" }}" {{ "}}" }}
            {{ "{{hub" }} end {{ "hub}}" }}
            {{ "{{" }} $gitopsNamespace := "{{ "{{hub" }} index .ManagedClusterLabels "autoshift.io/autoshift-gitops-namespace" | default "{{ index (index $.Values "autoshift" | default dict) "gitopsNamespace" | default "openshift-gitops" }}" {{ "hub}}" }}" {{ "}}" }}
            {{ "{{" }} $valuesFile := "{{ "{{hub" }} index .ManagedClusterLabels "autoshift.io/autoshift-values-file" | default (printf "%s.%s.%s" "values" .ManagedClusterName "yaml")   {{ "hub}}" }}" {{ "}}" }}
            {{ "{{" }} $argoProject := "{{ "{{hub" }} index .ManagedClusterLabels "autoshift.io/autoshift-argo-project" | default "default"  {{ "hub}}" }}" {{ "}}" }}
            {{ "{{" }} $targetRevision := "{{ "{{hub" }} index .ManagedClusterLabels "autoshift.io/autoshift-target-revision" | default "main" {{ "hub}}" }}" {{ "}}" }}
            {{ "{{" }} $autoshiftEnabled := "{{ "{{hub" }} index .ManagedClusterLabels "autoshift.io/autoshift-enable-install" | default "" {{ "hub}}" }}" {{ "}}" }}
            {{ "{{" }} if and  (ne $targetRevision "") (ne $gitopsNamespace "") (ne $valuesFile "") (eq $autoshiftEnabled "true") (ne ($repoUrl | default "") "") {{ "}}" }}
            - complianceType: musthave
              objectDefinition:
                apiVersion: argoproj.io/v1alpha1
                kind: Application
                metadata:
                  name: {{ "{{" }} $appName {{ "}}" }}
                  namespace: {{ "{{" }} $gitopsNamespace {{ "}}" }}
                spec:
                  destination:
                    namespace: ''
                    server: https://kubernetes.default.svc
                  source:
                    path: autoshift
                    repoURL: {{ "{{" }} $repoUrl {{ "}}" }}
                    targetRevision: {{ "{{" }} $targetRevision {{ "}}" }}
                    helm:
                      valueFiles:
                        - {{ "{{" }} $valuesFile {{ "}}" }}
                      values: |-
                        autoshiftGitRepo: {{ "{{" }} $repoUrl {{ "}}" }}
                        autoshiftGitBranchTag: {{ "{{" }} $targetRevision {{ "}}" }}
                  sources: []
                  project: {{ "{{" }} $argoProject {{ "}}" }}
                  syncPolicy:
                    automated:
                      prune: false
                      selfHeal: true
            {{ "{{" }} end {{ "}}" }}
---
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: {{ $placementName }}
  namespace: {{ $policyNamespace }}
spec:
  clusterSets:
    {{- range $clusterSet, $_ := $.Values.hubClusterSets }}
    - {{ $clusterSet }}
    {{- end }}
  predicates:
    - requiredClusterSelector:
        labelSelector:
          matchLabels:
            {{ printf "%s%s" ($.Values.autoshiftLabelPrefix | default "autoshift.io/") "autoshift-enable-install" }}: "true"
            {{ printf "%s%s" ($.Values.autoshiftLabelPrefix | default "autoshift.io/") "self-managed" }}: "false"
  tolerations:
    - key: cluster.open-cluster-management.io/unreachable
      operator: Exists
    - key: cluster.open-cluster-management.io/unavailable
      operator: Exists
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: {{ $placementName }}
  namespace: {{ $policyNamespace }}
placementRef:
  name: {{ $placementName}}
  apiGroup: cluster.open-cluster-management.io
  kind: Placement
subjects:
  - name: {{ $policyName }}
    apiGroup: policy.open-cluster-management.io
    kind: Policy
---
