# apiVersion: policy.open-cluster-management.io/v1
# kind: Policy
# metadata:
#   name: policy-vault-secret-creation
#   namespace: {{ .Values.policy_namespace }}
#   annotations:
#     policy.open-cluster-management.io/standards: AutoShiftv2
#     policy.open-cluster-management.io/categories: Trident
#     policy.open-cluster-management.io/controls: OpenShift Standard
# spec:
#   disabled: false
#   ### dependencies should include the policies from VSO install
#   dependencies:
#     - name: policy-vault-secrets-operator-install
#       namespace: {{ .Values.policy_namespace }}
#       apiVersion: policy.open-cluster-management.io/v1
#       compliance: Compliant
#       kind: Policy
#   policy-templates:
#     - objectDefinition:
#         apiVersion: policy.open-cluster-management.io/v1
#         kind: ConfigurationPolicy
#         metadata:
#           name: create-vault-secret
#         spec:
#           remediationAction: enforce # will be overridden by remediationAction in parent policy
#           severity: high
#           object-templates-raw: |
#             - complianceType: mustonlyhave
#               objectDefinition:
#                 apiVersion: secrets.hashicorp.com/v1beta1
#                 kind: VaultConnection
#                 metadata:
#                   name: vault-connection
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                 spec:
#                   address: {{ .Values.vault.connectionAddress }}
#                   skipTLSVerify: true
#     - objectDefinition:
#         apiVersion: policy.open-cluster-management.io/v1
#         kind: ConfigurationPolicy
#         metadata:
#           name: vault-auth
#         spec:
#           remediationAction: enforce # will be overridden by remediationAction in parent policy
#           severity: high
#           object-templates-raw: |
#             - complianceType: mustonlyhave
#               objectDefinition:
#                 apiVersion: secrets.hashicorp.com/v1beta1
#                 kind: VaultAuth
#                 metadata:
#                   name: vault-auth
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                 spec:
#                   jwt:
#                     serviceAccount: {{ .Values.vault.serviceAccount }}
#                   kubernetes:
#                     role: {{ .Values.vault.role }}
#                     serviceAccount: {{ .Values.vault.serviceAccount }}
#                     tokenExpirationSeconds: 600
#                   method: kubernetes
#                   mount: {{ .Values.vault.authMountName }}
#                   namespace: {{ .Values.vault.vaultNamespace }}
#                   vaultConnectionRef: vault-connection
#     - objectDefinition:
#         apiVersion: policy.open-cluster-management.io/v1
#         kind: ConfigurationPolicy
#         metadata:
#           name: vault-static-secret
#         spec:
#           remediationAction: enforce # will be overridden by remediationAction in parent policy
#           severity: high
#           object-templates-raw: |
#             - complianceType: mustonlyhave
#               objectDefinition:
#                 apiVersion: secrets.hashicorp.com/v1beta1
#                 kind: VaultStaticSecret
#                 metadata:
#                   name: vault-secret 
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                 spec:
#                   destination:
#                     create: true
#                     name: {{ .Values.vault.secretName }}
#                     overwrite: true
#                     transformation: {}
#                   hmacSecretData: true
#                   mount: {{ .Values.vault.mount }}
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                   path: {{ .Values.vault.path }}
#                   refreshAfter: 5s
#                   type: kv-v2
#                   vaultAuthRef: vault-auth
# ---
# apiVersion: cluster.open-cluster-management.io/v1beta1
# kind: Placement
# metadata:
#   name: placement-policy-vault-secret-creation
#   namespace: {{ .Values.policy_namespace }}
# spec:
#   clusterSets:
#   {{- range $clusterSet, $value := $.Values.managedClusterSets }}
#     - {{ $clusterSet }}
#   {{- end }}
#   {{- range $clusterSet, $value := $.Values.hubClusterSets }}
#     - {{ $clusterSet }}
#   {{- end }}
#   predicates:
#     - requiredClusterSelector:
#         labelSelector:
#           matchExpressions:
#             - key: 'autoshift.io/vault-secrets'
#               operator: In
#               values:
#               - 'true'
#   tolerations:
#     - key: cluster.open-cluster-management.io/unreachable
#       operator: Exists
#     - key: cluster.open-cluster-management.io/unavailable
#       operator: Exists
# ---
# apiVersion: policy.open-cluster-management.io/v1
# kind: PlacementBinding
# metadata:
#   name: placement-policy-vault-secret-creation
#   namespace: {{ .Values.policy_namespace }}
# placementRef:
#   name: placement-policy-vault-secret-creation
#   apiGroup: cluster.open-cluster-management.io
#   kind: Placement
# subjects:
#   - name: policy-vault-secret-creation
#     apiGroup: policy.open-cluster-management.io
#     kind: Policy