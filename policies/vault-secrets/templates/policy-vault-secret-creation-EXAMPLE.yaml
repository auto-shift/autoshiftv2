# {{- $policynamespace := .Values.policy_namespace -}}
# {{- $policyName := "policy-vault-secrets-operator-install" }}
# {{- $placementName := "placement-policy-vault-secrets-operator-install" }}
# apiVersion: policy.open-cluster-management.io/v1
# kind: Policy
# metadata:
#   name: {{ $policyName }}
#   namespace: {{ .Values.policy_namespace }}
#   annotations:
#     policy.open-cluster-management.io/standards: NIST SP 800-53
#     policy.open-cluster-management.io/categories: CM Configuration Management
#     policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
# spec:
#   disabled: false
#   ### dependencies should include the policies from VSO install
#   dependencies:
#     - name: #####  # Change this dependency to your operators install policy 
#       namespace: {{ .Values.policy_namespace }}
#       apiVersion: policy.open-cluster-management.io/v1
#       compliance: Compliant
#       kind: Policy
#     - name: policy-vault-secrets-operator-install
#       namespace: {{ .Values.policy_namespace }}
#       apiVersion: policy.open-cluster-management.io/v1
#       compliance: Compliant
#       kind: Policy
#   policy-templates:
#     - objectDefinition:
#         apiVersion: policy.open-cluster-management.io/v1
#         kind: ConfigurationPolicy
#         metadata:
#           name: operator-approle-creds-secret
#         spec:
#           remediationAction: enforce # will be overridden by remediationAction in parent policy
#           severity: high
#           object-templates-raw: |
#             {{ "{{hub" }} $secret := index .ManagedClusterLabels "autoshift.io/vault-secret-ref" {{ "hub}}" }}
#             - complianceType: musthave
#               objectDefinition:
#                 apiVersion: v1
#                 kind: Secret
#                 metadata:
#                   name: {{ "{{hub"}} $secret {{ "hub}}" }}
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                 type: Opaque
#                 data:
#                   id: {{ "{{hub" }} fromSecret "{{ $policynamespace }}" $secret "id" {{ "hub}}" }}
#     - objectDefinition:
#         apiVersion: policy.open-cluster-management.io/v1
#         kind: ConfigurationPolicy
#         metadata:
#           name: operator-vault-connection
#         spec:
#           remediationAction: enforce # will be overridden by remediationAction in parent policy
#           severity: high
#           object-templates-raw: |
#             - complianceType: mustonlyhave
#               objectDefinition:
#                 apiVersion: secrets.hashicorp.com/v1beta1
#                 kind: VaultConnection
#                 metadata:
#                   name: vault-connection
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                 spec:
#                   address: {{ .Values.vault.connectionAddress }}
#                   skipTLSVerify: true
#     - objectDefinition:
#         apiVersion: policy.open-cluster-management.io/v1
#         kind: ConfigurationPolicy
#         metadata:
#           name: operator-vault-auth
#         spec:
#           remediationAction: enforce # will be overridden by remediationAction in parent policy
#           severity: high
#           object-templates-raw: |
#             - complianceType: mustonlyhave
#               objectDefinition:
#                 kind: VaultAuth
#                 apiVersion: secrets.hashicorp.com/v1beta1
#                 metadata:
#                   name: vault-auth
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                 spec:
#                   vaultConnectionRef: vault-connection
#                   method: appRole
#                   mount: approle
#                   appRole:
#                     roleId: {{ .Values.vault.roleID }}
#                     secretRef: {{ .Values.vault.secretRef }}
#     - objectDefinition:
#         apiVersion: policy.open-cluster-management.io/v1
#         kind: ConfigurationPolicy
#         metadata:
#           name: operator-vault-static-secret
#         spec:
#           remediationAction: enforce # will be overridden by remediationAction in parent policy
#           severity: high
#           object-templates-raw: |
#             - complianceType: mustonlyhave
#               objectDefinition:
#                 apiVersion: secrets.hashicorp.com/v1beta1
#                 kind: VaultStaticSecret
#                 metadata:
#                   name: vault-secret 
#                   namespace: {{ .Values.vault.operatorNamespace }}
#                 spec:
#                   destination:
#                     create: true
#                     name: {{ .Values.vault.secretName }}
#                     overwrite: true
#                     transformation:
#                       excludeRaw: true
#                   hmacSecretData: true
#                   mount: {{ .Values.vault.mount }}
#                   namespace: {{ .Values.vault.namespace }}
#                   path: {{ .Values.vault.path }}
#                   refreshAfter: 5s
#                   type: kv-v2
#                   vaultAuthRef: vault-auth
# ---
# apiVersion: cluster.open-cluster-management.io/v1beta1
# kind: Placement
# metadata:
#   name: {{ $placementName }}
#   namespace: {{ .Values.policy_namespace }}
# spec:
#   clusterSets:
#   {{- range $clusterSet, $value := $.Values.hubClusterSets }}
#     - {{ $clusterSet }}
#   {{- end }}
#   {{- range $clusterSet, $value := $.Values.managedClusterSets }}
#     - {{ $clusterSet }}
#   {{- end }}
#   predicates:
#     - requiredClusterSelector:
#         labelSelector:
#           matchExpressions:
#             - key: 'autoshift.io/CHANGEME-vault-secret'
#               operator: In
#               values:
#               - 'true'
#   tolerations:
#     - key: cluster.open-cluster-management.io/unreachable
#       operator: Exists
#     - key: cluster.open-cluster-management.io/unavailable
#       operator: Exists
# ---
# apiVersion: policy.open-cluster-management.io/v1
# kind: PlacementBinding
# metadata:
#   name: {{ $placementName }}
#   namespace: {{ .Values.policy_namespace }}
# placementRef:
#   name: {{ $placementName }}
#   apiGroup: cluster.open-cluster-management.io
#   kind: Placement
# subjects:
#   - name: {{ $policyName }}
#     apiGroup: policy.open-cluster-management.io
#     kind: Policy