# {{- $policyName := "policy-vault-secrets-secret-sync" }}
# {{- $placementName := "placement-policy-vault-secrets-secret-sync" }}
# {{- $dependencyName := "policy-vault-secrets-connections" }}

# apiVersion: policy.open-cluster-management.io/v1
# kind: Policy
# metadata:
#   name: {{ $policyName }}
#   namespace: {{ .Values.policy_namespace }}
#   annotations:
#     policy.open-cluster-management.io/standards: NIST SP 800-53
#     policy.open-cluster-management.io/categories: CM Configuration Management
#     policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
# spec:
#   disabled: false
#   ### dependencies should include the policies from VSO install
#   dependencies:
#     - name: policy-vault-secrets-connections
#       namespace: {{ .Values.policy_namespace }}
#       apiVersion: policy.open-cluster-management.io/v1
#       compliance: Compliant
#       kind: Policy
#   policy-templates:
#     - objectDefinition:
#             apiVersion: policy.open-cluster-management.io/v1
#             kind: ConfigurationPolicy
#             metadata:
#               name: vault-static-secrets
#             spec:
#               remediationAction: enforce # will be overridden by remediationAction in parent policy
#               severity: high
#               object-templates-raw: |
#                 - complianceType: mustonlyhave
#                   objectDefinition:
#                     apiVersion: secrets.hashicorp.com/v1beta1
#                     kind: VaultStaticSecret
#                     metadata:
#                       name: SECRETNAME
#                       namespace: {{ .Values.vault.operatorNamespace }}
#                     spec:
#                       destination:
#                         create: true
#                         name: OPENSHIFT-SECRET-NAME
#                         overwrite: true
#                         transformation:
#                           excludeRaw: true
#                       hmacSecretData: true
#                       mount: {{ .Values.vault.mount }}
#                       path: PATH-OF-SECRET
#                       refreshAfter: 5s
#                       type: kv-v2
#                       vaultAuthRef: vault-auth
#                 - complianceType: mustonlyhave
#                   objectDefinition:
#                     apiVersion: secrets.hashicorp.com/v1beta1
#                     kind: VaultStaticSecret
#                     metadata:
#                       name: SECRETNAME
#                       namespace: {{ .Values.vault.operatorNamespace }}
#                     spec:
#                       destination:
#                         create: true
#                         name: OPENSHIFT-SECRET-NAME
#                         overwrite: true
#                         transformation:
#                           excludeRaw: true
#                       hmacSecretData: true
#                       mount: {{ .Values.vault.mount }}
#                       path: PATH-OF-SECRET
#                       refreshAfter: 5s
#                       type: kv-v2
#                       vaultAuthRef: vault-auth
# ---
# apiVersion: cluster.open-cluster-management.io/v1beta1
# kind: Placement
# metadata:
#   name: {{ $placementName }}
#   namespace: {{ .Values.policy_namespace }}
# spec:
#   clusterSets:
#   {{- range $clusterSet, $value := $.Values.managedClusterSets }}
#     - {{ $clusterSet }}
#   {{- end }}
#   {{- range $clusterSet, $value := $.Values.hubClusterSets }}
#     - {{ $clusterSet }}
#   {{- end }}
#   predicates:
#     - requiredClusterSelector:
#         labelSelector:
#           matchExpressions:
#             - key: 'autoshift.io/vault-secrets'
#               operator: In
#               values:
#               - 'true'
#   tolerations:
#     - key: cluster.open-cluster-management.io/unreachable
#       operator: Exists
#     - key: cluster.open-cluster-management.io/unavailable
#       operator: Exists
# ---
# apiVersion: policy.open-cluster-management.io/v1
# kind: PlacementBinding
# metadata:
#   name: {{ $placementName }}
#   namespace: {{ .Values.policy_namespace }}
# placementRef:
#   name: {{ $placementName }}
#   apiGroup: cluster.open-cluster-management.io
#   kind: Placement
# subjects:
#   - name: {{ $policyName }}
#     apiGroup: policy.open-cluster-management.io
#     kind: Policy