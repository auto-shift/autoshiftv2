# Default values for disconnected-mirror policy
# This policy manages ImageDigestMirrorSet and CatalogSource for disconnected environments
policy_namespace: open-cluster-policies

# Disconnected mirror configuration
# Policy is enabled via cluster labels: autoshift.io/disconnected-mirror: 'true'
disconnectedMirror:
  # Default mirror registry components (can be overridden per cluster via labels)
  # Full URL is constructed as: {host}:{port}/{path}
  # Example: mirror.example.com:5000/mirror
  host: ""
  port: "5000"
  path: ""

  # Use ImageDigestMirrorSet (OCP 4.13+) or legacy ImageContentSourcePolicy
  # IDMS is preferred for OCP 4.13+, set to false for older versions
  useIDMS: true

  # Image digest mirrors - maps source registries to mirror registry
  # These are typically generated by oc-mirror
  # Mirror URL format: {host}:{port}/{path}/{source}
  # Example: mirror.example.com:5000/ocp/registry.redhat.io
  mirrors:
    - source: registry.redhat.io
    - source: quay.io
    - source: registry.access.redhat.com

  # Operator catalog sources
  # These replace the default OperatorHub catalogs with mirrored versions
  # Names use {original-catalog}{suffix} pattern to match operator policy source selection
  # Default suffix is "-mirror", configurable via autoshift.io/mirror-catalog-suffix label
  catalogs:
    # Red Hat operators catalog
    - name: redhat-operators-mirror
      displayName: "Red Hat Operators (Mirrored)"
      # Image path relative to mirror registry
      # Full image will be: mirrorRegistry/imagePath
      imagePath: "redhat/redhat-operator-index"
      # Tag for the catalog image (typically matches OCP version)
      tag: "v4.18"
      # Publisher name
      publisher: "Red Hat"
      # Update policy
      updateStrategy: "manual"
      # Priority (higher = higher priority, default Red Hat catalog is 0)
      priority: -100

    # Certified operators catalog (optional)
    # - name: certified-operators-mirror
    #   displayName: "Certified Operators (Mirrored)"
    #   imagePath: "redhat/certified-operator-index"
    #   tag: "v4.18"
    #   publisher: "Red Hat"
    #   updateStrategy: "manual"
    #   priority: -100

    # Community operators catalog (optional)
    # - name: community-operators-mirror
    #   displayName: "Community Operators (Mirrored)"
    #   imagePath: "redhat/community-operator-index"
    #   tag: "v4.18"
    #   publisher: "Red Hat"
    #   updateStrategy: "manual"
    #   priority: -100

  # Note: Disabling default OperatorHub catalogs is controlled via a separate label
  # Use label: autoshift.io/disable-default-catalogs: 'true'
  # This allows clusters to use disconnected mirrors without disabling default catalogs
  # (useful for hybrid/partial connectivity scenarios)

# Cluster sets to apply the policy to
# hubClusterSets:
#   hub:
#     labels: {}
# managedClusterSets:
#   managed:
#     labels: {}

### AutoShift Labels Documentation
# This policy uses label-based activation and configuration
# The following labels can be set at the cluster or clusterset level:
#
# Enable/Disable:
# autoshift.io/disconnected-mirror: 'true'         - Enable disconnected mirror configuration (IDMS/ICSP + CatalogSources)
# autoshift.io/disable-default-catalogs: 'true'    - Disable default OperatorHub catalogs (optional, independent)
#
# Mirror Registry Configuration (optional - overrides values.yaml defaults):
# autoshift.io/mirror-registry-host: 'mirror.example.com' - Mirror registry hostname
# autoshift.io/mirror-registry-port: '5000'                - Mirror registry port
# autoshift.io/mirror-registry-path: 'mirror'              - Mirror registry base path
#
# Registry URL Construction:
# - Full registry URL is built from components: {host}:{port}/{path}
# - Example: mirror.example.com:5000/mirror
# - If path is empty, URL becomes: {host}:{port}
# - Labels override values.yaml defaults per cluster/clusterset
# - Different clusters can use different registries via labels
#
# How it works:
# 1. Mirror configuration applies to clusters with: autoshift.io/disconnected-mirror: 'true'
#    - Configures ImageDigestMirrorSet (OCP 4.13+) or ICSP (4.12-)
#    - Creates mirrored CatalogSources for operators
# 2. Disabling default catalogs is separate: autoshift.io/disable-default-catalogs: 'true'
#    - Can be used independently or together with disconnected-mirror
#    - Useful for fully disconnected environments
# 3. Mirror registry URL constructed from component labels (or values.yaml defaults)
#
# Example cluster labels for fully disconnected cluster:
# autoshift.io/disconnected-mirror: 'true'
# autoshift.io/disable-default-catalogs: 'true'
# autoshift.io/mirror-registry-host: 'hub-mirror.example.com'
# autoshift.io/mirror-registry-port: '5000'
# autoshift.io/mirror-registry-path: 'ocp'
#
# Example for cluster with mirror but internet access (caching/performance):
# autoshift.io/disconnected-mirror: 'true'
# autoshift.io/mirror-registry-host: 'cache-mirror.example.com'
# (no disable-default-catalogs label - keeps access to default catalogs)
#
# === Operator CatalogSource Switching ===
# When autoshift.io/disconnected-mirror=true is set:
# - ALL operators automatically switch from '{source}' to '{source}{suffix}' (e.g., redhat-operators-mirror)
# - Suffix is configurable via 'autoshift.io/mirror-catalog-suffix' label (default: -mirror)
# - Individual operators can still override via autoshift.io/OPERATOR-source labels
# - No need to configure each operator separately
#
# Example: Setting disconnected-mirror=true on a cluster automatically switches:
# - ACS operator: redhat-operators → redhat-operators-mirror
# - ACM operator: redhat-operators → redhat-operators-mirror
# - GitOps operator: redhat-operators → redhat-operators-mirror
# - (all other operators follow the same pattern)
#
# === Implementation Steps ===
# 1. Mirror content: ./scripts/generate-imageset-config.sh && oc-mirror --config imageset-config.yaml docker://mirror.example.com:5000
# 2. Apply labels using one of these methods:
#    a) CLI: oc label managedcluster my-cluster autoshift.io/disconnected-mirror=true autoshift.io/mirror-registry-host=mirror.example.com
#    b) ManagedClusterSet: oc label managedclusterset my-set autoshift.io/disconnected-mirror=true (inherits to all clusters)
#    c) GitOps: Add labels to ManagedCluster YAML and commit
# 3. ACM policies automatically configure:
#    - ImageDigestMirrorSet/ICSP to redirect image pulls
#    - CatalogSources pointing to mirrored catalogs (e.g., redhat-operators-mirror)
#    - All operators switch to use mirrored catalog sources
