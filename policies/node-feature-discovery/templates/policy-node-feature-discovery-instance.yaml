{{- $policyName := "policy-nfd-instance-deploy" }}
{{- $placementName := "placement-policy-nfs-instance-deploy" }}

apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: {{ $policyName }}
  namespace: {{ .Values.policy_namespace }}
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
spec:
  disabled: false
  dependencies:
    - name: policy-nfd-operator-install
      namespace: {{ .Values.policy_namespace }}
      apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: Policy
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: node-feature-discovery-instance-deploy
        spec:
          remediationAction: enforce
          severity: high
          object-templates:
            - complianceType: musthave
              objectDefinition:
                apiVersion: nfd.openshift.io/v1
                kind: NodeFeatureDiscovery
                metadata:
                  name: nfd-instance
                  namespace: openshift-nfd
                spec:
                  enableTaints: false
                  instance: ''
                  operand:
                    image: {{ .Values.nodeFeatureDiscovery.operandImage }}
                    imagePullPolicy: Always
                    servicePort: 0
                  prunerOnDelete: false
                  topologyUpdater: false
                  workerConfig:
                    configData: |
                      core:
                      #  labelWhiteList:
                      #  noPublish: false
                        sleepInterval: 60s
                      #  sources: [all]
                      #  klog:
                      #    addDirHeader: false
                      #    alsologtostderr: false
                      #    logBacktraceAt:
                      #    logtostderr: true
                      #    skipHeaders: false
                      #    stderrthreshold: 2
                      #    v: 0
                      #    vmodule:
                      ##   NOTE: the following options are not dynamically run-time configurable
                      ##         and require a nfd-worker restart to take effect after being changed
                      #    logDir:
                      #    logFile:
                      #    logFileMaxSize: 1800
                      #    skipLogHeaders: false
                      sources:
                        cpu:
                          cpuid:
                      #     NOTE: whitelist has priority over blacklist
                            attributeBlacklist:
                              - "BMI1"
                              - "BMI2"
                              - "CLMUL"
                              - "CMOV"
                              - "CX16"
                              - "ERMS"
                              - "F16C"
                              - "HTT"
                              - "LZCNT"
                              - "MMX"
                              - "MMXEXT"
                              - "NX"
                              - "POPCNT"
                              - "RDRAND"
                              - "RDSEED"
                              - "RDTSCP"
                              - "SGX"
                              - "SSE"
                              - "SSE2"
                              - "SSE3"
                              - "SSE4.1"
                              - "SSE4.2"
                              - "SSSE3"
                            attributeWhitelist:
                        kernel:
                          kconfigFile: "/path/to/kconfig"
                          configOpts:
                            - "NO_HZ"
                            - "X86"
                            - "DMI"
                        pci:
                          deviceClassWhitelist:
                            - "0200"
                            - "03"
                            - "0302"
                            - "12"
                          deviceLabelFields:
                            - "class"
---
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: {{ $placementName }}
  namespace: {{ .Values.policy_namespace }}
spec:
  clusterSets:
  {{- range $clusterSet, $value := $.Values.hubClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  {{- range $clusterSet, $value := $.Values.managedClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  predicates:
    - requiredClusterSelector:
        labelSelector:
          matchExpressions:
            - key: 'autoshift.io/node-feature-discovery'
              operator: In
              values:
              - 'true'
  tolerations:
    - key: cluster.open-cluster-management.io/unreachable
      operator: Exists
    - key: cluster.open-cluster-management.io/unavailable
      operator: Exists
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: {{ $placementName }}
  namespace: {{ .Values.policy_namespace }}
placementRef:
  name: {{ $placementName }}
  apiGroup: cluster.open-cluster-management.io
  kind: Placement
subjects:
  - name: {{ $policyName }}
    apiGroup: policy.open-cluster-management.io
    kind: Policy