# This policy creates per-host NodeNetworkConfigurationPolicy resources from labels
# Use this when different hosts need different network configurations (e.g., different IPs)
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-nmstate-host-config
  namespace: {{ .Values.policy_namespace }}
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
spec:
{{ if (($.Values.autoshift).dryRun) }}
  remediationAction: inform
{{ end }}
  dependencies:
    - name: policy-nmstate
      namespace: {{ .Values.policy_namespace }}
      apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: Policy
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: nmstate-host-config
        spec:
          remediationAction: enforce
          severity: high
          evaluationInterval:
            compliant: {{ ((($.Values.autoshift).evaluationInterval).compliant) | default "10m" }}
            noncompliant: {{ ((($.Values.autoshift).evaluationInterval).noncompliant) | default "30s" }}
          object-templates-raw: |
            {{ "{{hub-" }} $labels := .ManagedClusterLabels {{ "hub}}" }}

            {{- /* ============================================================ */ -}}
            {{- /* Discover host IDs dynamically (anchor: -hostname suffix)      */ -}}
            {{- /* ============================================================ */ -}}
            {{ "{{hub-" }} $hostIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := .ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix "autoshift.io/nmstate-host-" $label {{ "hub}}" }}
                {{ "{{hub-" }} if hasSuffix "-hostname" $label {{ "hub}}" }}
                  {{ "{{hub-" }} $rest := trimPrefix "autoshift.io/nmstate-host-" $label {{ "hub}}" }}
                  {{ "{{hub-" }} $hostId := trimSuffix "-hostname" $rest {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $hostId $hostIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $hostIds = append $hostIds $hostId {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{ "{{hub-" }} range $hostId := $hostIds {{ "hub}}" }}
            {{ "{{hub-" }} $hostname := index $labels (printf "autoshift.io/nmstate-host-%s-hostname" $hostId) {{ "hub}}" }}
            {{ "{{hub-" }} $hostPrefix := printf "autoshift.io/nmstate-host-%s-" $hostId {{ "hub}}" }}

            {{- /* Discover per-host bond IDs */ -}}
            {{ "{{hub-" }} $bondIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%sbond-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} $rest := trimPrefix (printf "%sbond-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if not (contains "-" $rest) {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $rest $bondIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $bondIds = append $bondIds $rest {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{- /* Discover per-host VLAN IDs */ -}}
            {{ "{{hub-" }} $vlanIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%svlan-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} $rest := trimPrefix (printf "%svlan-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if not (contains "-" $rest) {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $rest $vlanIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $vlanIds = append $vlanIds $rest {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{- /* Discover per-host ethernet IDs */ -}}
            {{ "{{hub-" }} $ethernetIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%sethernet-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} $rest := trimPrefix (printf "%sethernet-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if not (contains "-" $rest) {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $rest $ethernetIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $ethernetIds = append $ethernetIds $rest {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{- /* Discover per-host OVS bridge IDs */ -}}
            {{ "{{hub-" }} $ovsBridgeIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%sovs-bridge-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} $rest := trimPrefix (printf "%sovs-bridge-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if not (contains "-" $rest) {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $rest $ovsBridgeIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $ovsBridgeIds = append $ovsBridgeIds $rest {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{- /* Discover per-host OVN mapping IDs (anchor: -localnet) */ -}}
            {{ "{{hub-" }} $ovnMappingIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%sovn-mapping-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if hasSuffix "-localnet" $label {{ "hub}}" }}
                  {{ "{{hub-" }} $rest := trimPrefix (printf "%sovn-mapping-" $hostPrefix) $label {{ "hub}}" }}
                  {{ "{{hub-" }} $mappingId := trimSuffix "-localnet" $rest {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $mappingId $ovnMappingIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $ovnMappingIds = append $ovnMappingIds $mappingId {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{- /* Discover per-host route IDs (anchor: -dest) */ -}}
            {{ "{{hub-" }} $routeIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%sroute-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if hasSuffix "-dest" $label {{ "hub}}" }}
                  {{ "{{hub-" }} $rest := trimPrefix (printf "%sroute-" $hostPrefix) $label {{ "hub}}" }}
                  {{ "{{hub-" }} $routeId := trimSuffix "-dest" $rest {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $routeId $routeIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $routeIds = append $routeIds $routeId {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{- /* Discover per-host DNS server IDs */ -}}
            {{ "{{hub-" }} $dnsServerIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%sdns-server-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} $rest := trimPrefix (printf "%sdns-server-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if not (contains "-" $rest) {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $rest $dnsServerIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $dnsServerIds = append $dnsServerIds $rest {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            {{- /* Discover per-host DNS search IDs */ -}}
            {{ "{{hub-" }} $dnsSearchIds := list {{ "hub}}" }}
            {{ "{{hub-" }} range $label, $val := $.ManagedClusterLabels {{ "hub}}" }}
              {{ "{{hub-" }} if hasPrefix (printf "%sdns-search-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} $rest := trimPrefix (printf "%sdns-search-" $hostPrefix) $label {{ "hub}}" }}
                {{ "{{hub-" }} if not (contains "-" $rest) {{ "hub}}" }}
                  {{ "{{hub-" }} if not (has $rest $dnsSearchIds) {{ "hub}}" }}
                    {{ "{{hub-" }} $dnsSearchIds = append $dnsSearchIds $rest {{ "hub}}" }}
                  {{ "{{hub-" }} end {{ "hub}}" }}
                {{ "{{hub-" }} end {{ "hub}}" }}
              {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}

            - complianceType: mustonlyhave
              objectDefinition:
                apiVersion: nmstate.io/v1
                kind: NodeNetworkConfigurationPolicy
                metadata:
                  name: nmstate-host-{{ "{{hub" }} $hostId {{ "hub}}" }}
                spec:
                  nodeSelector:
                    kubernetes.io/hostname: {{ "{{hub" }} $hostname {{ "hub}}" }}
                  desiredState:
                    interfaces:
                      {{ "{{hub-" }} range $ethId := $ethernetIds {{ "hub}}" }}
                      {{ "{{hub-" }} $ethName := index $labels (printf "%sethernet-%s" $hostPrefix $ethId) {{ "hub}}" }}
                      {{ "{{hub-" }} $ethState := index $labels (printf "%sethernet-%s-state" $hostPrefix $ethId) | default "up" {{ "hub}}" }}
                      {{ "{{hub-" }} $ethMac := index $labels (printf "%sethernet-%s-mac" $hostPrefix $ethId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $ethMtu := index $labels (printf "%sethernet-%s-mtu" $hostPrefix $ethId) | default "" {{ "hub}}" }}
                      - name: {{ "{{hub" }} $ethName {{ "hub}}" }}
                        type: ethernet
                        state: {{ "{{hub" }} $ethState {{ "hub}}" }}
                        {{ "{{hub-" }} if $ethMac {{ "hub}}" }}
                        mac-address: '{{ "{{hub" }} replace "." ":" $ethMac {{ "hub}}" }}'
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} if $ethMtu {{ "hub}}" }}
                        mtu: {{ "{{hub" }} $ethMtu {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} range $bondId := $bondIds {{ "hub}}" }}
                      {{ "{{hub-" }} $bondName := index $labels (printf "%sbond-%s" $hostPrefix $bondId) {{ "hub}}" }}
                      {{ "{{hub-" }} $bondState := index $labels (printf "%sbond-%s-state" $hostPrefix $bondId) | default "up" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMode := index $labels (printf "%sbond-%s-mode" $hostPrefix $bondId) | default "802.3ad" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMtu := index $labels (printf "%sbond-%s-mtu" $hostPrefix $bondId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMac := index $labels (printf "%sbond-%s-mac" $hostPrefix $bondId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondMiimon := index $labels (printf "%sbond-%s-miimon" $hostPrefix $bondId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondIpv4 := index $labels (printf "%sbond-%s-ipv4" $hostPrefix $bondId) | default "disabled" {{ "hub}}" }}
                      {{ "{{hub-" }} $bondIpv6 := index $labels (printf "%sbond-%s-ipv6" $hostPrefix $bondId) | default "disabled" {{ "hub}}" }}

                      {{ "{{hub-" }} $bondPorts := list {{ "hub}}" }}
                      {{ "{{hub-" }} $portPrefix := printf "%sbond-%s-port-" $hostPrefix $bondId {{ "hub}}" }}
                      {{ "{{hub-" }} range $plabel, $pval := $.ManagedClusterLabels {{ "hub}}" }}
                        {{ "{{hub-" }} if hasPrefix $portPrefix $plabel {{ "hub}}" }}
                          {{ "{{hub-" }} $bondPorts = append $bondPorts $pval {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      {{ "{{hub-" }} $bondIpv4Addrs := list {{ "hub}}" }}
                      {{ "{{hub-" }} $addrPrefix := printf "%sbond-%s-ipv4-address-" $hostPrefix $bondId {{ "hub}}" }}
                      {{ "{{hub-" }} range $alabel, $aval := $.ManagedClusterLabels {{ "hub}}" }}
                        {{ "{{hub-" }} if and (hasPrefix $addrPrefix $alabel) (not (hasSuffix "-cidr" $alabel)) {{ "hub}}" }}
                          {{ "{{hub-" }} $addrId := trimPrefix $addrPrefix $alabel {{ "hub}}" }}
                          {{ "{{hub-" }} $cidr := index $labels (printf "%sbond-%s-ipv4-address-%s-cidr" $hostPrefix $bondId $addrId) | default "24" {{ "hub}}" }}
                          {{ "{{hub-" }} $bondIpv4Addrs = append $bondIpv4Addrs (dict "ip" $aval "prefix" $cidr) {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      {{ "{{hub-" }} $bondIpv6Addrs := list {{ "hub}}" }}
                      {{ "{{hub-" }} $addr6Prefix := printf "%sbond-%s-ipv6-address-" $hostPrefix $bondId {{ "hub}}" }}
                      {{ "{{hub-" }} range $alabel, $aval := $.ManagedClusterLabels {{ "hub}}" }}
                        {{ "{{hub-" }} if and (hasPrefix $addr6Prefix $alabel) (not (hasSuffix "-cidr" $alabel)) {{ "hub}}" }}
                          {{ "{{hub-" }} $addrId := trimPrefix $addr6Prefix $alabel {{ "hub}}" }}
                          {{ "{{hub-" }} $cidr := index $labels (printf "%sbond-%s-ipv6-address-%s-cidr" $hostPrefix $bondId $addrId) | default "64" {{ "hub}}" }}
                          {{ "{{hub-" }} $bondIpv6Addrs = append $bondIpv6Addrs (dict "ip" $aval "prefix" $cidr) {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      - name: {{ "{{hub" }} $bondName {{ "hub}}" }}
                        type: bond
                        state: {{ "{{hub" }} $bondState {{ "hub}}" }}
                        {{ "{{hub-" }} if $bondMac {{ "hub}}" }}
                        mac-address: '{{ "{{hub" }} replace "." ":" $bondMac {{ "hub}}" }}'
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} if $bondMtu {{ "hub}}" }}
                        mtu: {{ "{{hub" }} $bondMtu {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        ipv4:
                          {{ "{{hub-" }} if eq $bondIpv4 "disabled" {{ "hub}}" }}
                          enabled: false
                          {{ "{{hub-" }} else if eq $bondIpv4 "dhcp" {{ "hub}}" }}
                          enabled: true
                          dhcp: true
                          {{ "{{hub-" }} else if eq $bondIpv4 "static" {{ "hub}}" }}
                          enabled: true
                          dhcp: false
                          {{ "{{hub-" }} if gt (len $bondIpv4Addrs) 0 {{ "hub}}" }}
                          address:
                            {{ "{{hub-" }} range $addr := $bondIpv4Addrs {{ "hub}}" }}
                            - ip: {{ "{{hub" }} $addr.ip {{ "hub}}" }}
                              prefix-length: {{ "{{hub" }} $addr.prefix {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        ipv6:
                          {{ "{{hub-" }} if eq $bondIpv6 "disabled" {{ "hub}}" }}
                          enabled: false
                          {{ "{{hub-" }} else if eq $bondIpv6 "dhcp" {{ "hub}}" }}
                          enabled: true
                          dhcp: true
                          {{ "{{hub-" }} else if eq $bondIpv6 "autoconf" {{ "hub}}" }}
                          enabled: true
                          autoconf: true
                          {{ "{{hub-" }} else if eq $bondIpv6 "static" {{ "hub}}" }}
                          enabled: true
                          dhcp: false
                          autoconf: false
                          {{ "{{hub-" }} if gt (len $bondIpv6Addrs) 0 {{ "hub}}" }}
                          address:
                            {{ "{{hub-" }} range $addr := $bondIpv6Addrs {{ "hub}}" }}
                            - ip: {{ "{{hub" }} $addr.ip {{ "hub}}" }}
                              prefix-length: {{ "{{hub" }} $addr.prefix {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        link-aggregation:
                          mode: {{ "{{hub" }} $bondMode {{ "hub}}" }}
                          {{ "{{hub-" }} if $bondMiimon {{ "hub}}" }}
                          options:
                            miimon: {{ "{{hub" }} $bondMiimon {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} if gt (len $bondPorts) 0 {{ "hub}}" }}
                          port:
                            {{ "{{hub-" }} range $port := $bondPorts {{ "hub}}" }}
                            - {{ "{{hub" }} $port {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} range $vlanId := $vlanIds {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanName := index $labels (printf "%svlan-%s" $hostPrefix $vlanId) {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanVid := index $labels (printf "%svlan-%s-id" $hostPrefix $vlanId) {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanBase := index $labels (printf "%svlan-%s-base" $hostPrefix $vlanId) {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanState := index $labels (printf "%svlan-%s-state" $hostPrefix $vlanId) | default "up" {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanMtu := index $labels (printf "%svlan-%s-mtu" $hostPrefix $vlanId) | default "" {{ "hub}}" }}
                      {{ "{{hub-" }} $vlanIpv4 := index $labels (printf "%svlan-%s-ipv4" $hostPrefix $vlanId) | default "disabled" {{ "hub}}" }}

                      {{ "{{hub-" }} $vlanIpv4Addrs := list {{ "hub}}" }}
                      {{ "{{hub-" }} $addrPrefix := printf "%svlan-%s-ipv4-address-" $hostPrefix $vlanId {{ "hub}}" }}
                      {{ "{{hub-" }} range $alabel, $aval := $.ManagedClusterLabels {{ "hub}}" }}
                        {{ "{{hub-" }} if and (hasPrefix $addrPrefix $alabel) (not (hasSuffix "-cidr" $alabel)) {{ "hub}}" }}
                          {{ "{{hub-" }} $addrId := trimPrefix $addrPrefix $alabel {{ "hub}}" }}
                          {{ "{{hub-" }} $cidr := index $labels (printf "%svlan-%s-ipv4-address-%s-cidr" $hostPrefix $vlanId $addrId) | default "24" {{ "hub}}" }}
                          {{ "{{hub-" }} $vlanIpv4Addrs = append $vlanIpv4Addrs (dict "ip" $aval "prefix" $cidr) {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      - name: {{ "{{hub" }} $vlanName {{ "hub}}" }}
                        type: vlan
                        state: {{ "{{hub" }} $vlanState {{ "hub}}" }}
                        {{ "{{hub-" }} if $vlanMtu {{ "hub}}" }}
                        mtu: {{ "{{hub" }} $vlanMtu {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        vlan:
                          base-iface: {{ "{{hub" }} $vlanBase {{ "hub}}" }}
                          id: {{ "{{hub" }} $vlanVid {{ "hub}}" }}
                        ipv4:
                          {{ "{{hub-" }} if eq $vlanIpv4 "disabled" {{ "hub}}" }}
                          enabled: false
                          {{ "{{hub-" }} else if eq $vlanIpv4 "dhcp" {{ "hub}}" }}
                          enabled: true
                          dhcp: true
                          {{ "{{hub-" }} else if eq $vlanIpv4 "static" {{ "hub}}" }}
                          enabled: true
                          dhcp: false
                          {{ "{{hub-" }} if gt (len $vlanIpv4Addrs) 0 {{ "hub}}" }}
                          address:
                            {{ "{{hub-" }} range $addr := $vlanIpv4Addrs {{ "hub}}" }}
                            - ip: {{ "{{hub" }} $addr.ip {{ "hub}}" }}
                              prefix-length: {{ "{{hub" }} $addr.prefix {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} range $ovsId := $ovsBridgeIds {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsBridgeName := index $labels (printf "%sovs-bridge-%s" $hostPrefix $ovsId) {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsStp := index $labels (printf "%sovs-bridge-%s-stp" $hostPrefix $ovsId) | default "false" {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsAllowExtraPatch := index $labels (printf "%sovs-bridge-%s-allow-extra-patch-ports" $hostPrefix $ovsId) | default "true" {{ "hub}}" }}
                      {{ "{{hub-" }} $ovsMcastSnooping := index $labels (printf "%sovs-bridge-%s-mcast-snooping" $hostPrefix $ovsId) | default "" {{ "hub}}" }}

                      {{ "{{hub-" }} $ovsBridgePorts := list {{ "hub}}" }}
                      {{ "{{hub-" }} $portPrefix := printf "%sovs-bridge-%s-port-" $hostPrefix $ovsId {{ "hub}}" }}
                      {{ "{{hub-" }} range $plabel, $pval := $.ManagedClusterLabels {{ "hub}}" }}
                        {{ "{{hub-" }} if hasPrefix $portPrefix $plabel {{ "hub}}" }}
                          {{ "{{hub-" }} $ovsBridgePorts = append $ovsBridgePorts $pval {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}

                      - name: {{ "{{hub" }} $ovsBridgeName {{ "hub}}" }}
                        type: ovs-bridge
                        state: up
                        bridge:
                          allow-extra-patch-ports: {{ "{{hub" }} $ovsAllowExtraPatch {{ "hub}}" }}
                          options:
                            stp: {{ "{{hub" }} $ovsStp {{ "hub}}" }}
                            {{ "{{hub-" }} if $ovsMcastSnooping {{ "hub}}" }}
                            mcast-snooping-enable: {{ "{{hub" }} $ovsMcastSnooping {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} if gt (len $ovsBridgePorts) 0 {{ "hub}}" }}
                          port:
                            {{ "{{hub-" }} range $port := $ovsBridgePorts {{ "hub}}" }}
                            - name: {{ "{{hub" }} $port {{ "hub}}" }}
                            {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                      {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} if gt (len $routeIds) 0 {{ "hub}}" }}
                    routes:
                      config:
                        {{ "{{hub-" }} range $routeId := $routeIds {{ "hub}}" }}
                        {{ "{{hub-" }} $routeDest := index $labels (printf "%sroute-%s-dest" $hostPrefix $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeCidr := index $labels (printf "%sroute-%s-cidr" $hostPrefix $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeGw := index $labels (printf "%sroute-%s-gateway" $hostPrefix $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeIface := index $labels (printf "%sroute-%s-interface" $hostPrefix $routeId) {{ "hub}}" }}
                        {{ "{{hub-" }} $routeMetric := index $labels (printf "%sroute-%s-metric" $hostPrefix $routeId) | default "" {{ "hub}}" }}
                        {{ "{{hub-" }} $routeTable := index $labels (printf "%sroute-%s-table" $hostPrefix $routeId) | default "" {{ "hub}}" }}
                        - destination: {{ "{{hub" }} $routeDest {{ "hub}}" }}/{{ "{{hub" }} $routeCidr {{ "hub}}" }}
                          next-hop-address: {{ "{{hub" }} $routeGw {{ "hub}}" }}
                          next-hop-interface: {{ "{{hub" }} $routeIface {{ "hub}}" }}
                          {{ "{{hub-" }} if $routeMetric {{ "hub}}" }}
                          metric: {{ "{{hub" }} $routeMetric {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                          {{ "{{hub-" }} if $routeTable {{ "hub}}" }}
                          table-id: {{ "{{hub" }} $routeTable {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} end {{ "hub}}" }}

                    {{ "{{hub-" }} if or (gt (len $dnsServerIds) 0) (gt (len $dnsSearchIds) 0) {{ "hub}}" }}
                    dns-resolver:
                      config:
                        {{ "{{hub-" }} if gt (len $dnsServerIds) 0 {{ "hub}}" }}
                        server:
                          {{ "{{hub-" }} range $dnsId := $dnsServerIds {{ "hub}}" }}
                          {{ "{{hub-" }} $server := index $labels (printf "%sdns-server-%s" $hostPrefix $dnsId) {{ "hub}}" }}
                          - {{ "{{hub" }} $server {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} if gt (len $dnsSearchIds) 0 {{ "hub}}" }}
                        search:
                          {{ "{{hub-" }} range $searchId := $dnsSearchIds {{ "hub}}" }}
                          {{ "{{hub-" }} $domain := index $labels (printf "%sdns-search-%s" $hostPrefix $searchId) {{ "hub}}" }}
                          - {{ "{{hub" }} $domain {{ "hub}}" }}
                          {{ "{{hub-" }} end {{ "hub}}" }}
                        {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} end {{ "hub}}" }}

                    {{ "{{hub-" }} if gt (len $ovnMappingIds) 0 {{ "hub}}" }}
                    ovn:
                      bridge-mappings:
                        {{ "{{hub-" }} range $mappingId := $ovnMappingIds {{ "hub}}" }}
                        {{ "{{hub-" }} $localnetName := index $labels (printf "%sovn-mapping-%s-localnet" $hostPrefix $mappingId) {{ "hub}}" }}
                        {{ "{{hub-" }} $bridgeName := index $labels (printf "%sovn-mapping-%s-bridge" $hostPrefix $mappingId) {{ "hub}}" }}
                        - localnet: {{ "{{hub" }} $localnetName {{ "hub}}" }}
                          bridge: {{ "{{hub" }} $bridgeName {{ "hub}}" }}
                          state: present
                        {{ "{{hub-" }} end {{ "hub}}" }}
                    {{ "{{hub-" }} end {{ "hub}}" }}
            {{ "{{hub-" }} end {{ "hub}}" }}
---
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: placement-policy-nmstate-host-config
  namespace: {{ .Values.policy_namespace }}
spec:
  clusterSets:
  {{- range $clusterSet, $value := $.Values.managedClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  {{- range $clusterSet, $value := $.Values.hubClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  predicates:
    - requiredClusterSelector:
        labelSelector:
          matchExpressions:
            - key: 'autoshift.io/nmstate'
              operator: In
              values:
              - 'true'
  tolerations:
    - key: cluster.open-cluster-management.io/unreachable
      operator: Exists
    - key: cluster.open-cluster-management.io/unavailable
      operator: Exists
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: placement-policy-nmstate-host-config
  namespace: {{ .Values.policy_namespace }}
placementRef:
  name: placement-policy-nmstate-host-config
  apiGroup: cluster.open-cluster-management.io
  kind: Placement
subjects:
  - name: policy-nmstate-host-config
    apiGroup: policy.open-cluster-management.io
    kind: Policy
