# This policy sets the default storage class annotation on all storage classes.
# It ensures only the configured storage class is set as default.
#
# By default, sets ocs-storagecluster-ceph-rbd as the default storage class.
# Configure via label: autoshift.io/odf-default-storageclass: 'storageclass-name'
#
# Note: This policy does NOT apply when odf-multi-cloud-gateway: 'standalone'
# because standalone mode only deploys NooBaa (object storage), not block storage.
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-default-storageclass
  namespace: {{ .Values.policy_namespace }}
  annotations:
    policy.open-cluster-management.io/standards: NIST SP 800-53
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
spec:
{{ if (($.Values.autoshift).dryRun) }}
  remediationAction: inform
{{ end }}
  dependencies:
    - name: policy-storage-cluster-test
      namespace: {{ .Values.policy_namespace }}
      apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: Policy
  disabled: false
  policy-templates:
    - objectDefinition:
        apiVersion: policy.open-cluster-management.io/v1
        kind: ConfigurationPolicy
        metadata:
          name: set-default-storageclass
        spec:
          object-templates-raw: |
              {{ "{{hub" }} $defaultSC := index .ManagedClusterLabels "autoshift.io/odf-default-storageclass" | default "ocs-storagecluster-ceph-rbd" {{ "hub}}" }}
              {{ "{{-" }} $storageclasses := (lookup "storage.k8s.io/v1" "StorageClass" "" "").items {{ "}}" }}
              {{ "{{-" }} range $sc := $storageclasses {{ "}}" }}
              - complianceType: musthave
                objectDefinition:
                  apiVersion: storage.k8s.io/v1
                  kind: StorageClass
                  metadata:
                    name: {{ "{{" }} $sc.metadata.name {{ "}}" }}
                    annotations:
                      storageclass.kubernetes.io/is-default-class: '{{ "{{" }} if eq $sc.metadata.name "{{ "{{hub" }} $defaultSC {{ "hub}}" }}" {{ "}}" }}true{{ "{{" }} else {{ "}}" }}false{{ "{{" }} end {{ "}}" }}'
              {{ "{{-" }} end {{ "}}" }}
          pruneObjectBehavior: None
          remediationAction: enforce
          severity: medium
---
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: placement-policy-default-storageclass
  namespace: {{ .Values.policy_namespace }}
spec:
  clusterSets:
  {{- range $clusterSet, $value := $.Values.managedClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  {{- range $clusterSet, $value := $.Values.hubClusterSets }}
    - {{ $clusterSet }}
  {{- end }}
  predicates:
    - requiredClusterSelector:
        labelSelector:
          matchExpressions:
            - key: 'autoshift.io/odf'
              operator: In
              values:
              - 'true'
            - key: 'autoshift.io/odf-multi-cloud-gateway'
              operator: NotIn
              values:
              - 'standalone'
  tolerations:
    - key: cluster.open-cluster-management.io/unreachable
      operator: Exists
    - key: cluster.open-cluster-management.io/unavailable
      operator: Exists
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: placement-policy-default-storageclass
  namespace: {{ .Values.policy_namespace }}
placementRef:
  name: placement-policy-default-storageclass
  apiGroup: cluster.open-cluster-management.io
  kind: Placement
subjects:
  - name: policy-default-storageclass
    apiGroup: policy.open-cluster-management.io
    kind: Policy
